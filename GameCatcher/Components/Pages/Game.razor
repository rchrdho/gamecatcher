@page "/game"
@using System.Text
@using GameCatcher.Models;
@using GameCatcher.Services;
@inject HttpClient httpClient

<PageTitle>Game</PageTitle>

@if (isLoading)
{
  <div>Loading games...</div>
}
else if (gamesList is null || !gamesList.Any())
{
  <div>No games found.</div>
}
else
{
  <div class="d-flex flex-wrap gap-3">
    @foreach (var g in gamesList)
    {
      <div class="card" style="width: 18rem;">
        <img src="@g?.ArtworkUrl" class="card-img-top" alt="Artwork image">
        <div class="card-body">
          <h5 class="card-title">@g?.Name</h5>
        </div>
      </div>
    }
  </div>
}

@code {
  private IgdbService igdbService = new IgdbService();
  private List<GameDetails>? gamesList;
  private List<PeakGames>? peakGames;
  private bool isLoading = true;

  protected override async Task OnInitializedAsync()
  {
    await FetchGamesAsync();
  }

  private async Task<List<IGDB.Models.PopularityPrimitive>?> GetPeakGamesAsync(int limit)
  {
    return await igdbService.GetPeakGamesAsync(limit);
  }
  private async Task FetchGamesAsync()
  {
    isLoading = true;
    gamesList = new List<GameDetails>();

    List<IGDB.Models.PopularityPrimitive>? wantToPlayGames = await GetPeakGamesAsync(30);
    if (wantToPlayGames == null || !wantToPlayGames.Any())
    {
      isLoading = false;
      StateHasChanged();
      return;
    }

    // batch ids and request artworks in same call to avoid per-id requests
    List<int>? ids = wantToPlayGames.Where(g => g?.GameId != null).Select(g => (int)g!.GameId!).Distinct().ToList();
    List<IGDB.Models.Game>? games = await igdbService.GetGamesByIdsAsync(ids, "name,summary,artworks.image_id");

    foreach (var gameDetails in games)
    {
      IGDB.Models.Artwork? artwork = gameDetails?.Artworks?.Values?.FirstOrDefault(a => !string.IsNullOrEmpty(a?.ImageId));
      if (artwork == null)
        continue;

      gamesList.Add(new GameDetails
      {
        Name = gameDetails?.Name,
        Summary = gameDetails?.Summary,
        ArtworkUrl = IGDB.ImageHelper.GetImageUrl(imageId: artwork?.ImageId, size: IGDB.ImageSize.ScreenshotBig)
      });
    }

    isLoading = false;
    StateHasChanged();
  }
}