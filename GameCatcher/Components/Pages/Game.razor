@page "/game"
@using System.Text
@using GameCatcher.Models;
@inject HttpClient httpClient

<PageTitle>Game</PageTitle>

@if (isLoading)
{
  <div>Loading games...</div>
}
else if (gamesList is null || !gamesList.Any())
{
  <div>No games found.</div>
}
else
{
  <div class="d-flex flex-wrap gap-3">
    @foreach (var g in gamesList)
    {
      <div class="card" style="width: 18rem;">
        <img src="@g?.Cover?.Url" class="card-img-top" alt="Cover image">
        <div class="card-body">
          <h5 class="card-title">@g?.Name</h5>
          <p class="card-text">@g?.Summary</p>
          <a href="#" class="btn btn-primary">Details</a>
        </div>
      </div>
    }
  </div>
}

@code {
  string? baseUrl = "https://api.igdb.com/v4/";
  string? clientId = "75tjz90rrtop8md5n3e1xa09pismd8";
  string? accessToken = "jer0oto3pvwl5trhk52b9abhda1d3o";
  private List<GameDetails> gamesList = new List<GameDetails>();
  private PeakGames? peakGames;
  private bool isLoading = true;

  protected override async Task OnInitializedAsync()
  {
    await FetchGameData();
  }

  private async Task FetchGameData()
  {
    try
    {
      string apiUrl = $"{baseUrl}popularity_primitives";

      string requestBody = $"fields game_id,value,popularity_type; sort value desc; limit 10; where popularity_type = 5;";

      var requestMessage = new HttpRequestMessage(HttpMethod.Post, apiUrl)
      {
        Content = new StringContent(requestBody, Encoding.UTF8, "application/json")
      };

      requestMessage.Headers.Add("Client-Id", $"{clientId}");
      requestMessage.Headers.Add("Authorization", $"Bearer {accessToken}");

      var response = await httpClient.SendAsync(requestMessage);

      if (response.IsSuccessStatusCode)
      {
        List<PeakGames>? pGames = await response.Content.ReadFromJsonAsync<List<PeakGames>>();

        if (pGames?.Any() == true)
        {
          foreach (PeakGames pg in pGames)
          {
            peakGames = pg;
            int gameId = peakGames.GameId;
            Console.WriteLine(gameId);

            string gameApiUrl = $"{baseUrl}games";
            string gameRequestBody = $"fields name, summary, cover.url; where id = {gameId};";

            HttpRequestMessage? gameRequestMessage = new HttpRequestMessage(HttpMethod.Post, gameApiUrl)
            {
              Content = new StringContent(gameRequestBody, Encoding.UTF8, "application/json")
            };
            gameRequestMessage.Headers.Add("Client-Id", $"{clientId}");
            gameRequestMessage.Headers.Add("Authorization", $"Bearer {accessToken}");

            HttpResponseMessage? gameResponse = await httpClient.SendAsync(gameRequestMessage);

            if (gameResponse.IsSuccessStatusCode)
            {
              List<GameDetails>? fetched = await gameResponse.Content.ReadFromJsonAsync<List<GameDetails>>();

              if (fetched?.Any() == true)
              {
                GameDetails? game = fetched.First();

                if (game?.Cover != null && !string.IsNullOrEmpty(game.Cover.Url))
                {
                  game.Cover.Url = "https:" + game.Cover.Url.Replace("t_thumb", "t_cover_big");
                }

                gamesList.Add(game!);
              }
              else
              {
                Console.WriteLine($"No game details found for game id {gameId}.");
              }
            }
            else
            {
              Console.WriteLine($"Failed to fetch game details for id {gameId}. Status Code: {gameResponse.StatusCode}");
            }
          }
        }
        else
        {
          Console.WriteLine("No popularity primitives returned.");
        }
      }
      else
      {
        Console.WriteLine($"Failed to fetch popularity primitives. Status Code: {response.StatusCode}");
      }
    }
    catch (Exception ex)
    {
      Console.WriteLine($"Error fetching game data: {ex.Message}");
    }
    finally
    {
      isLoading = false;
      StateHasChanged();
    }
  }

}