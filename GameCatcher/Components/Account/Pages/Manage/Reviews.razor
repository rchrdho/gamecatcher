@page "/Account/Manage/Reviews"

@using GameCatcher.Services
@using IGDB
@using GameCatcher.Data
@using GameCatcher.Models

@inject AuthenticationStateProvider AuthenticationStateProvider
@inject GameCatcher.DatabaseService.IReviewService ReviewDbService

<h3>Your Reviews</h3>

@if (userReviews.Count == 0)
{
    <p>You have not submitted any reviews yet.</p>
}
else
{
    @foreach (var review in userReviews)
    {
        <div class="card mt-3">
            <div class="card-header">
                <a href="/game/info/@review.GameId">@gameDetails?.Name</a>
                <span class="text-muted">- @review.CreatedAt.ToString("MMMM dd, yyyy")</span>
                <span class="float-end">Rating: @review.Rating</span>
            </div>
            <div class="card-body">
                <p class="card-text">@review.Comment</p>
            </div>
        </div>
    }
}

@code {
    private List<Review> userReviews = new();

    private IGDBService _igdbService = new();

    private Game? gameDetails;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var userPrincipal = authState.User;
        var userId = userPrincipal.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        if (userId != null)
        {
            userReviews = await ReviewDbService.GetReviewsByUserId(userId);
        }

        await FetchGameName();
    }

    private async Task FetchGameName()
    {
        foreach (var review in userReviews)
        {
            IGDB.Models.Game? game = await _igdbService.GetGameBySingleIdAsync(review.GameId);
            IGDB.Models.Artwork? artwork = game?.Artworks?.Values?.FirstOrDefault();

            gameDetails = new Game
            {
                Name = game?.Name,
                ArtworkImageId = IGDB.ImageHelper.GetImageUrl(imageId: artwork?.ImageId, size: IGDB.ImageSize.CoverSmall)
            };
        }
    }
}